<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GroupsApp</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Geist+Mono:wght@400;500&family=Geist:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/css/main.css">
</head>
<body>

<!-- ==================== PANTALLA AUTH ==================== -->
<div id="screen-auth" class="screen active">
  <div class="auth-bg">
    <div class="auth-orb auth-orb-1"></div>
    <div class="auth-orb auth-orb-2"></div>
    <div class="auth-grid"></div>
  </div>
  <div class="auth-card">
    <div class="auth-brand">
      <div class="brand-mark">G</div>
      <div>
        <h1 class="brand-name">GroupsApp</h1>
        <p class="brand-sub">Sistema de mensajería distribuida</p>
      </div>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-login" onclick="switchAuthTab('login')">Iniciar sesión</button>
      <button class="auth-tab" id="tab-register" onclick="switchAuthTab('register')">Crear cuenta</button>
    </div>
    <div id="auth-error" class="auth-error hidden"></div>

    <!-- Login -->
    <div id="form-login" class="auth-form">
      <div class="field-group">
        <label class="field-label">Correo electrónico</label>
        <input type="email" id="login-email" class="field-input" placeholder="tu@email.com" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <div class="field-group">
        <label class="field-label">Contraseña</label>
        <input type="password" id="login-pass" class="field-input" placeholder="••••••••" onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <button class="btn-auth" onclick="doLogin()">Entrar</button>
    </div>

    <!-- Register -->
    <div id="form-register" class="auth-form hidden">
      <div class="field-group">
        <label class="field-label">Nombre completo</label>
        <input type="text" id="reg-name" class="field-input" placeholder="Tu nombre">
      </div>
      <div class="field-group">
        <label class="field-label">Correo electrónico</label>
        <input type="email" id="reg-email" class="field-input" placeholder="tu@email.com">
      </div>
      <div class="field-group">
        <label class="field-label">Contraseña <span class="field-hint">mín. 6 caracteres</span></label>
        <input type="password" id="reg-pass" class="field-input" placeholder="••••••••" onkeydown="if(event.key==='Enter')doRegister()">
      </div>
      <button class="btn-auth" onclick="doRegister()">Crear cuenta</button>
    </div>
  </div>
</div>

<!-- ==================== PANTALLA APP ==================== -->
<div id="screen-app" class="screen">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-top">
      <div class="sidebar-brand">
        <span class="sidebar-logo">G·</span>
        <span class="sidebar-title">GroupsApp</span>
      </div>
      <div class="sidebar-actions">
        <button class="icon-btn" title="Invitaciones" onclick="showPanel('invitations')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          <span id="inv-badge" class="badge hidden">0</span>
        </button>
        <button class="icon-btn" title="Nuevo grupo" onclick="openModal('modal-create-group')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        </button>
      </div>
    </div>

    <div class="sidebar-search">
      <svg class="search-icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" class="search-input" placeholder="Buscar grupos..." oninput="filterGroups(this.value)">
    </div>

    <nav class="sidebar-nav">
      <button class="nav-pill active" id="nav-groups" onclick="showPanel('groups')">Grupos</button>
      <button class="nav-pill" id="nav-invitations" onclick="showPanel('invitations')">Invitaciones</button>
    </nav>

    <div class="panel-groups sidebar-scroll" id="panel-groups">
      <div id="groups-list"></div>
    </div>

    <div class="panel-invitations sidebar-scroll hidden" id="panel-invitations">
      <div id="invitations-list"></div>
    </div>

    <div class="sidebar-user">
      <div class="user-avatar-wrap">
        <div class="user-avatar" id="my-avatar">?</div>
        <div class="presence-dot online"></div>
      </div>
      <div class="user-info">
        <div class="user-name" id="my-name">—</div>
        <div class="user-email" id="my-email">—</div>
      </div>
      <div class="user-actions">
        <button class="icon-btn-sm" title="Configuración" onclick="openModal('modal-profile')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14M4.93 4.93a10 10 0 0 0 0 14.14"/></svg>
        </button>
        <button class="icon-btn-sm danger" title="Cerrar sesión" onclick="logout()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        </button>
      </div>
    </div>
  </aside>

  <!-- MAIN PANEL -->
  <main class="main-panel">
    <!-- Welcome state -->
    <div class="welcome-state" id="welcome-state">
      <div class="welcome-icon">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      </div>
      <h2 class="welcome-title">Bienvenido a GroupsApp</h2>
      <p class="welcome-sub">Selecciona un grupo para comenzar</p>
    </div>

    <!-- Group view -->
    <div class="group-view hidden" id="group-view">
      <header class="group-header">
        <div class="group-avatar-lg" id="gv-avatar">G</div>
        <div class="group-header-info">
          <div class="group-header-name" id="gv-name">—</div>
          <div class="group-header-meta" id="gv-meta">—</div>
        </div>
        <div class="group-header-actions" id="gv-actions">
          <!-- Populated dynamically based on role -->
        </div>
      </header>

      <div class="group-body">
        <!-- Left: channels + members sidebar -->
        <div class="group-sidebar">
          <!-- Chat general -->
          <div class="gsidebar-section">
            <button class="channel-item general-chat" id="btn-general-chat" onclick="openGeneralChat()">
              <span class="ch-hash">#</span>
              <span>general</span>
            </button>
          </div>

          <!-- Channels -->
          <div class="gsidebar-section">
            <div class="gsidebar-label">
              <span>Canales</span>
              <button class="gsidebar-add hidden" id="btn-add-channel" title="Nuevo canal" onclick="openModal('modal-create-channel')">+</button>
            </div>
            <div id="channels-list"></div>
          </div>

          <!-- Members -->
          <div class="gsidebar-section">
            <div class="gsidebar-label"><span>Miembros</span></div>
            <div id="members-list"></div>
          </div>
        </div>

        <!-- Right: chat area -->
        <div class="chat-area" id="chat-area">
          <div class="chat-empty">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <p>Selecciona un canal para chatear</p>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- ==================== MODALES ==================== -->

<!-- Crear grupo -->
<div class="modal-overlay hidden" id="modal-create-group">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Nuevo grupo</h3>
      <button class="modal-close" onclick="closeModal('modal-create-group')">×</button>
    </div>
    <div class="field-group">
      <label class="field-label">Nombre</label>
      <input type="text" id="ng-name" class="field-input" placeholder="Ej: Proyecto Distribuido">
    </div>
    <div class="field-group">
      <label class="field-label">Descripción <span class="field-hint">opcional</span></label>
      <textarea id="ng-desc" class="field-input field-textarea" placeholder="¿De qué trata?"></textarea>
    </div>
    <div class="field-check">
      <input type="checkbox" id="ng-private" checked>
      <label for="ng-private">Grupo privado (solo por invitación)</label>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="closeModal('modal-create-group')">Cancelar</button>
      <button class="btn-primary" onclick="createGroup()">Crear grupo</button>
    </div>
  </div>
</div>

<!-- Editar grupo -->
<div class="modal-overlay hidden" id="modal-edit-group">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Editar grupo</h3>
      <button class="modal-close" onclick="closeModal('modal-edit-group')">×</button>
    </div>
    <div class="field-group">
      <label class="field-label">Nombre</label>
      <input type="text" id="eg-name" class="field-input">
    </div>
    <div class="field-group">
      <label class="field-label">Descripción</label>
      <textarea id="eg-desc" class="field-input field-textarea"></textarea>
    </div>
    <div class="field-check">
      <input type="checkbox" id="eg-private">
      <label for="eg-private">Grupo privado</label>
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="closeModal('modal-edit-group')">Cancelar</button>
      <button class="btn-primary" onclick="saveEditGroup()">Guardar</button>
    </div>
  </div>
</div>

<!-- Invitar usuario -->
<div class="modal-overlay hidden" id="modal-invite">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Invitar al grupo</h3>
      <button class="modal-close" onclick="closeModal('modal-invite')">×</button>
    </div>
    <div class="field-group">
      <label class="field-label">Email del usuario</label>
      <input type="email" id="invite-email" class="field-input" placeholder="usuario@email.com" onkeydown="if(event.key==='Enter')sendInvitation()">
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="closeModal('modal-invite')">Cancelar</button>
      <button class="btn-primary" onclick="sendInvitation()">Enviar invitación</button>
    </div>
  </div>
</div>

<!-- Crear canal -->
<div class="modal-overlay hidden" id="modal-create-channel">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">Nuevo canal</h3>
      <button class="modal-close" onclick="closeModal('modal-create-channel')">×</button>
    </div>
    <div class="field-group">
      <label class="field-label">Nombre</label>
      <input type="text" id="nc-name" class="field-input" placeholder="Ej: anuncios">
    </div>
    <div class="field-group">
      <label class="field-label">Descripción <span class="field-hint">opcional</span></label>
      <input type="text" id="nc-desc" class="field-input" placeholder="¿Para qué es?">
    </div>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="closeModal('modal-create-channel')">Cancelar</button>
      <button class="btn-primary" onclick="createChannel()">Crear canal</button>
    </div>
  </div>
</div>

<!-- Perfil / configuración de cuenta -->
<div class="modal-overlay hidden" id="modal-profile">
  <div class="modal modal-wide">
    <div class="modal-header">
      <h3 class="modal-title">Mi cuenta</h3>
      <button class="modal-close" onclick="closeModal('modal-profile')">×</button>
    </div>
    <div class="profile-tabs">
      <button class="profile-tab active" onclick="switchProfileTab('info', this)">Información</button>
      <button class="profile-tab" onclick="switchProfileTab('password', this)">Contraseña</button>
      <button class="profile-tab danger-tab" onclick="switchProfileTab('danger', this)">Cuenta</button>
    </div>
    <!-- Info tab -->
    <div id="ptab-info" class="profile-tab-content">
      <div class="field-group">
        <label class="field-label">Nombre completo</label>
        <input type="text" id="p-name" class="field-input">
      </div>
      <div class="field-group">
        <label class="field-label">Email</label>
        <input type="email" id="p-email" class="field-input">
      </div>
      
      <div class="modal-footer">
        <button class="btn-ghost" onclick="closeModal('modal-profile')">Cancelar</button>
        <button class="btn-primary" onclick="saveProfile()">Guardar cambios</button>
      </div>
    </div>
    <!-- Password tab -->
    <div id="ptab-password" class="profile-tab-content hidden">
      <div class="field-group">
        <label class="field-label">Contraseña actual</label>
        <input type="password" id="p-old-pass" class="field-input" placeholder="••••••••">
      </div>
      <div class="field-group">
        <label class="field-label">Nueva contraseña</label>
        <input type="password" id="p-new-pass" class="field-input" placeholder="mín. 6 caracteres">
      </div>
      <div class="modal-footer">
        <button class="btn-ghost" onclick="closeModal('modal-profile')">Cancelar</button>
        <button class="btn-primary" onclick="changePassword()">Cambiar contraseña</button>
      </div>
    </div>
    <!-- Danger zone tab -->
    <div id="ptab-danger" class="profile-tab-content hidden">
      <div class="danger-zone">
        <div class="danger-info">
          <strong>Eliminar cuenta</strong>
          <p>Esta acción desactivará tu cuenta permanentemente. No podrás iniciar sesión nuevamente.</p>
        </div>
        <button class="btn-danger" onclick="deleteAccount()">Eliminar mi cuenta</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmar expulsar miembro -->
<div class="modal-overlay hidden" id="modal-remove-member">
  <div class="modal modal-sm">
    <div class="modal-header">
      <h3 class="modal-title">Expulsar miembro</h3>
      <button class="modal-close" onclick="closeModal('modal-remove-member')">×</button>
    </div>
    <p class="modal-body-text">¿Seguro que quieres expulsar a <strong id="rm-member-name"></strong> del grupo?</p>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="closeModal('modal-remove-member')">Cancelar</button>
      <button class="btn-danger" onclick="confirmRemoveMember()">Expulsar</button>
    </div>
  </div>
</div>

<!-- Confirmar eliminar canal -->
<div class="modal-overlay hidden" id="modal-delete-channel">
  <div class="modal modal-sm">
    <div class="modal-header">
      <h3 class="modal-title">Eliminar canal</h3>
      <button class="modal-close" onclick="closeModal('modal-delete-channel')">×</button>
    </div>
    <p class="modal-body-text">¿Eliminar el canal <strong id="dc-name"></strong>? Se perderán todos los mensajes.</p>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="closeModal('modal-delete-channel')">Cancelar</button>
      <button class="btn-danger" onclick="confirmDeleteChannel()">Eliminar</button>
    </div>
  </div>
</div>

<!-- Confirmar eliminar grupo -->
<div class="modal-overlay hidden" id="modal-delete-group">
  <div class="modal modal-sm">
    <div class="modal-header">
      <h3 class="modal-title">Eliminar grupo</h3>
      <button class="modal-close" onclick="closeModal('modal-delete-group')">×</button>
    </div>
    <p class="modal-body-text">¿Eliminar el grupo <strong id="dg-name"></strong>? Esta acción es irreversible y eliminará todos los canales y mensajes.</p>
    <div class="modal-footer">
      <button class="btn-ghost" onclick="closeModal('modal-delete-group')">Cancelar</button>
      <button class="btn-danger" onclick="confirmDeleteGroup()">Eliminar grupo</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div id="toast-container"></div>

<!-- Context menu for messages -->
<div id="msg-context-menu" class="context-menu hidden">
  <button onclick="contextDeleteMessage()">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/></svg>
    Eliminar mensaje
  </button>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
<script src="/js/api.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/presence.js"></script>
<script src="/js/groups.js"></script>
<script src="/js/channels.js"></script>
<script src="/js/messaging.js"></script>
<script src="/js/app.js"></script>
</body>
</html>